# Test Audit Report: EE-004

## Test Information
- **Test ID:** EE-004
- **Test Name:** Storage Management Workflow
- **Implementation Location:** `/home/linh/ros2_ws/dimenvue_server/tests/ee/test_ee.py:450`
- **Function Name:** `test_ee_storage_management_workflow`
- **Audit Date:** 2025-12-18

## Compliance Status
**PARTIAL**

## Specification vs Implementation

### Required by Specification

| Step | Requirement | Status |
|------|-------------|--------|
| 1 | Capture 10 photos | PARTIAL - Only 3 photos captured |
| 2 | Record 3 videos | PARTIAL - Only 1 video recorded |
| 3 | GET /storage/internal/usage (check usage) | COMPLIANT |
| 4 | PUT /catalog/{uuid}/delete for 5 items | PARTIAL - Only 2 items deleted |
| 5 | GET /storage/internal/usage (verify reduced) | COMPLIANT |
| 6 | PUT /storage/internal/format | COMPLIANT |
| 7 | GET /catalog (verify empty) | COMPLIANT |
| 8 | GET /storage/internal/usage (verify zeroed) | NON-COMPLIANT - Missing |

### Implementation Details

#### What the Test Does
The implementation (lines 450-530) performs the following:

1. **Initialize camera** (lines 464-466)
2. **Capture 3 photos** (lines 468-472) - NOT 10 as specified
3. **Retrieve photo UUIDs from catalog** (lines 475-484)
4. **Record 1 video** (lines 486-492) - NOT 3 as specified
5. **Get storage usage** (lines 494-502)
   - Verifies photos_usage > 0
   - Verifies videos_usage > 0
6. **Delete 2 items** (lines 504-508) - NOT 5 as specified
7. **Get usage after deletion** (lines 510-516)
   - Verifies photos usage decreased
8. **Format internal storage** (lines 518-520)
9. **Get catalog and verify empty** (lines 522-526)
10. **Cleanup/deinitialize camera** (lines 528-530)

#### Missing from Implementation
- **Step 8 verification:** The test does NOT call `GET /storage/internal/usage` after formatting to verify usage is zeroed
- The test does NOT verify that storage usage increases with each capture/record as specified in the "Expects" section

## Discrepancies

### Critical Issues
1. **Missing final storage verification**: After formatting (line 519-520), the test should verify that storage usage is near-zero by calling `GET /storage/internal/usage` again
2. **Quantity mismatch**: The test uses significantly reduced quantities (3 photos vs 10, 1 video vs 3, 2 deletions vs 5)

### Minor Issues
1. **Incremental usage tracking**: The specification expects verification that "storage usage increases with each capture/record", but the implementation only checks usage once after all captures
2. **Proportional deletion verification**: The spec expects "deletion reduces usage proportionally", but the test only checks that usage decreased, not that it's proportional to items deleted

## Recommendations

### High Priority
1. **Add final usage check** after formatting:
   ```python
   # After line 520 (format)
   # Action 8: Get usage and verify zeroed
   response = await ee_client.get("/storage/internal/usage")
   assert response.status_code == 200
   usage_after_format = response.json()

   photos_final = usage_after_format.get("photos", 0)
   videos_final = usage_after_format.get("videos", 0)
   total_final = usage_after_format.get("total", 0)

   assert photos_final == 0 or photos_final < 1000, "Photos usage should be near-zero after format"
   assert videos_final == 0 or videos_final < 1000, "Videos usage should be near-zero after format"
   assert total_final < 5000, "Total usage should be minimal after format"
   ```

### Medium Priority
2. **Align quantities with specification** or update specification to match implementation:
   - Capture 10 photos instead of 3
   - Record 3 videos instead of 1
   - Delete 5 items instead of 2

   **Rationale for current implementation:** The reduced quantities likely make the test run faster, which is reasonable for EE tests. If performance is the concern, update the specification to document the actual test behavior.

### Low Priority
3. **Add incremental usage tracking** to verify usage increases with each capture:
   ```python
   usage_history = []

   for i in range(3):
       response = await ee_client.put("/cameraApp/capture")
       assert response.status_code == 200
       await asyncio.sleep(1)

       # Check usage after each capture
       response = await ee_client.get("/storage/internal/usage")
       current_usage = response.json().get("total", 0)
       usage_history.append(current_usage)

       if i > 0:
           assert current_usage > usage_history[i-1], "Usage should increase with each capture"
   ```

## Conclusion
The test implementation covers the core workflow but has two significant gaps:
1. **Missing final storage verification** after formatting (critical spec requirement)
2. **Quantity mismatches** between spec and implementation (affects test thoroughness)

The test should be updated to either fully comply with the specification or the specification should be revised to match the implementation's reduced scope.
