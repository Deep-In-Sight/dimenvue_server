# Test Audit Report: EE-006

**Test ID:** EE-006
**Test Name:** Preview Switching During Recording
**Implementation:** `/home/linh/ros2_ws/dimenvue_server/tests/ee/test_ee.py` (lines 626-708)
**Audit Date:** 2025-12-18
**Compliance Status:** PARTIAL

---

## Executive Summary

The test implementation follows the core workflow of switching preview during recording, but contains a critical discrepancy in the preview index values used. Additionally, some specification expectations regarding video duration and frame integrity are not explicitly validated.

---

## Specification Requirements vs Implementation

### Requirements Analysis

| Spec Step | Required | Implemented | Status |
|-----------|----------|-------------|--------|
| 1. PUT /cameraApp/recordStart | Yes | Yes (line 645) | ✓ PASS |
| 2. Wait 2 seconds | Yes | Yes (line 649) | ✓ PASS |
| 3. PUT /cameraApp/preview-index (index 1) | Yes | Yes (line 652) | ✓ PASS |
| 4. Wait 2 seconds | Yes | Yes (line 660) | ✓ PASS |
| 5. PUT /cameraApp/preview-index (index 3 - composite) | Yes | **NO - uses index 2** (line 663) | ✗ FAIL |
| 6. Wait 2 seconds | Yes | Yes (line 671) | ✓ PASS |
| 7. PUT /cameraApp/recordStop | Yes | Yes (line 674) | ✓ PASS |
| Recording continues uninterrupted | Yes | Not explicitly verified | ⚠ PARTIAL |
| Final video is 6+ seconds long | Yes | Not verified | ✗ FAIL |
| No dropped frames or corruption | Yes | Not verified | ✗ FAIL |
| All 3 camera files valid | Yes | Partial (checks count and size) | ⚠ PARTIAL |

---

## Detailed Findings

### 1. Camera Initialization ✓
- **Spec:** Implicit requirement (Given: Camera initialized)
- **Implementation:** Lines 640-642
- **Status:** COMPLIANT
- **Notes:** Includes 2-second stabilization delay after init.

### 2. Recording Start ✓
- **Spec:** `PUT /cameraApp/recordStart`
- **Implementation:** Lines 645-646
- **Status:** COMPLIANT
- **Notes:** Correctly verifies 200 OK response.

### 3. First Wait Period ✓
- **Spec:** Wait 2 seconds
- **Implementation:** Line 649
- **Status:** COMPLIANT

### 4. First Preview Switch ✓
- **Spec:** `PUT /cameraApp/preview-index` (switch to index 1)
- **Implementation:** Lines 652-657
- **Status:** COMPLIANT
- **Notes:**
  - Correctly switches to index 1
  - Validates response status and returned index value

### 5. Second Wait Period ✓
- **Spec:** Wait 2 seconds
- **Implementation:** Line 660
- **Status:** COMPLIANT

### 6. Second Preview Switch ✗
- **Spec:** `PUT /cameraApp/preview-index` (switch to index 3 - composite)
- **Implementation:** Lines 663-668
- **Status:** NON-COMPLIANT
- **Critical Issue:**
  - **Specification requires:** `index: 3` (composite view)
  - **Implementation uses:** `index: 2` (right camera)
  - This is a direct contradiction of the specification
- **Comment in code:** Line 662 says "Switch preview to index 2 (right camera)" which suggests intentional deviation
- **Docstring discrepancy:** Lines 635-636 in the docstring say "Switch preview to index 2", not index 3
- **Impact:** Test does not validate composite preview behavior during recording

### 7. Third Wait Period ✓
- **Spec:** Wait 2 seconds
- **Implementation:** Line 671
- **Status:** COMPLIANT

### 8. Recording Stop ✓
- **Spec:** `PUT /cameraApp/recordStop`
- **Implementation:** Lines 674-675
- **Status:** COMPLIANT

### 9. Recording Continuity Verification ⚠
- **Spec:** Recording continues uninterrupted during preview switches
- **Implementation:** No explicit verification
- **Status:** PARTIAL COMPLIANCE
- **Gaps:**
  - No check for error conditions during recording
  - No validation that recording state remained active throughout
  - Relies on successful recordStop as implicit proof
- **Note:** The final video existence suggests recording was not interrupted, but this is indirect

### 10. Video Duration Verification ✗
- **Spec:** Final video is 6+ seconds long
- **Implementation:** Not verified
- **Status:** NON-COMPLIANT
- **Gaps:**
  - No video duration check implemented
  - File size check exists (> 10KB) but size doesn't directly correlate to duration
- **Recommendation:** Add video metadata inspection to verify duration >= 6 seconds

### 11. Frame Integrity Verification ✗
- **Spec:** No dropped frames or corruption
- **Implementation:** Not verified
- **Status:** NON-COMPLIANT
- **Gaps:**
  - No frame analysis
  - No corruption detection
  - Only basic file size check (> 10KB)
- **Recommendation:** Add video file validation (e.g., ffprobe, OpenCV frame counting)

### 12. All 3 Camera Files Valid ⚠
- **Spec:** All 3 camera files valid
- **Implementation:** Lines 697-704
- **Status:** PARTIAL COMPLIANCE
- **What's tested:**
  - Verifies exactly 3 video files exist (line 699)
  - Checks each file size > 10KB (lines 702-704)
- **Gaps:**
  - No validation of video codec/format
  - No playback verification
  - No frame count check
  - "Valid" is interpreted as "exists and has content" rather than "playable and correct"

### 13. Cleanup ✓
- **Spec:** Implicit requirement
- **Implementation:** Lines 707-708
- **Status:** COMPLIANT
- **Notes:** Proper cleanup with deinit call.

---

## Gaps and Discrepancies

### Critical Issues

1. **Wrong Preview Index (Line 663):**
   - **Expected:** Index 3 (composite view)
   - **Actual:** Index 2 (right camera)
   - **Impact:** Does not test composite preview during recording as specified
   - **Root Cause:** Docstring also mentions index 2, suggesting specification and implementation diverged

2. **Missing Video Duration Validation:**
   - Specification explicitly requires "6+ seconds long"
   - No duration check implemented
   - Total recording time should be ~6 seconds (2s + 2s + 2s between switches)

3. **Missing Frame Integrity Checks:**
   - No verification of dropped frames
   - No corruption detection
   - Only basic file size validation

### Minor Issues

1. **Implicit vs Explicit Recording Continuity:**
   - Recording continuity is assumed but not explicitly verified
   - No state checks during preview switches

2. **File Validation Depth:**
   - "Valid" files only checked for existence and minimum size
   - No codec, format, or playability verification

---

## Recommendations

### High Priority

1. **Fix Preview Index Mismatch (Line 663-668):**
   ```python
   # Action 5: Switch preview to index 3 (composite)
   response = await ee_client.put(
       "/cameraApp/preview-index",
       json={"index": 3}
   )
   assert response.status_code == 200
   assert response.json().get("index") == 3
   ```
   **OR** update the specification if index 2 is the correct behavior.

2. **Add Video Duration Validation (after line 704):**
   ```python
   # Verify video duration
   import subprocess
   for vid_file in video_files:
       # Use ffprobe to get duration
       result = subprocess.run(
           ["ffprobe", "-v", "error", "-show_entries",
            "format=duration", "-of", "default=noprint_wrappers=1:nokey=1",
            str(vid_file)],
           capture_output=True, text=True
       )
       duration = float(result.stdout.strip())
       assert duration >= 6.0, f"Video too short: {duration}s (expected >= 6s)"
   ```

3. **Add Frame Count Verification (after line 704):**
   ```python
   # Check for dropped frames/corruption
   for vid_file in video_files:
       result = subprocess.run(
           ["ffprobe", "-v", "error", "-count_frames",
            "-select_streams", "v:0", "-show_entries",
            "stream=nb_read_frames", "-of", "default=noprint_wrappers=1:nokey=1",
            str(vid_file)],
           capture_output=True, text=True
       )
       frame_count = int(result.stdout.strip())
       # At 30fps, 6 seconds = ~180 frames minimum
       assert frame_count >= 150, f"Too few frames: {frame_count} (possible drops)"
   ```

### Medium Priority

1. **Add Recording State Verification During Switches:**
   ```python
   # After each preview switch, verify still recording
   response = await ee_client.get("/cameraApp/state")
   assert response.json().get("state") == "RECORDING"
   ```

2. **Enhance File Validation:**
   ```python
   # Verify video files are playable
   for vid_file in video_files:
       result = subprocess.run(
           ["ffprobe", "-v", "error", str(vid_file)],
           capture_output=True
       )
       assert result.returncode == 0, f"Video file corrupted: {vid_file}"
   ```

3. **Update Docstring (lines 627-638):**
   - Change "Switch preview to index 2" to "Switch preview to index 3"
   - Or align with implementation if index 2 is correct

---

## Specification Clarity Issues

The specification and implementation disagree on the second preview switch:
- **TEST_SPECS.md:** States "index 3 - composite"
- **Implementation docstring:** States "index 2"
- **Implementation code:** Uses index 2

**Recommendation:** Clarify with stakeholders whether:
- Index 3 (composite) is required, and implementation needs fixing
- Index 2 (right camera) is correct, and specification needs updating

---

## Conclusion

The test correctly implements the timing sequence and workflow structure of switching previews during recording. However, it contains a critical discrepancy in the preview index used for the second switch (index 2 vs. specified index 3).

Additionally, the test lacks validation for key quality metrics explicitly mentioned in the specification:
- Video duration (6+ seconds)
- Frame integrity (no dropped frames)
- File corruption checks

The test provides basic validation (files exist, have content) but falls short of the specification's expectations for thorough quality assurance.

**Overall Assessment:** The test demonstrates the capability to switch previews during recording without crashing, but needs corrections and enhancements to fully validate the specification requirements. The preview index discrepancy must be resolved first, followed by adding video quality validation.
